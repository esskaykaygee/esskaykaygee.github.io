<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Post Photo</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Post a Photo</h1>
      <a href="index.html" class="btn">Back</a>
    </header>

    <form id="postForm">
      <input type="file" id="image" accept="image/*" required />
      <input type="text" id="caption" placeholder="Enter caption" required />
      <button type="submit">Upload</button>
    </form>

    <script type="module">
      import { supabase } from "./supabase.js";

      const form = document.getElementById("postForm");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = document.getElementById("image").files[0];
        const caption = document.getElementById("caption").value;

        const fileName = `${Date.now()}-${file.name}`;

        // Upload image
        const { error: uploadError } = await supabase.storage
          .from("photos")
          .upload(fileName, file);

        if (uploadError) {
          alert("Upload failed");
          console.error(uploadError);
          return;
        }

        // Get public URL
        const { data: urlData } = supabase.storage
          .from("photos")
          .getPublicUrl(fileName);

        // ---- NEW: Get the user's ID from allowed_names ----
        const username = localStorage.getItem("username"); // make sure this is set
        if (!username) {
          alert("You must be logged in to post.");
          return;
        }

        const { data: userRow, error: userError } = await supabase
          .from("allowed_names")
          .select("id")
          .eq("name", username)
          .single();

        if (userError) {
          console.error(userError);
          alert("Could not find your user record.");
          return;
        }

        const name_id = userRow.id; // integer

        // Insert post with name_id
        const { error } = await supabase.from("posts").insert({
          image_url: urlData.publicUrl,
          caption: caption,
          name_id: name_id,
        });

        if (error) {
          console.error(error);
          alert("Error saving post");
          return;
        }

        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
